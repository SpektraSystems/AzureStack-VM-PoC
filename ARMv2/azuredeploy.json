{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "virtualMachineName": {
            "defaultValue": "AzS-HOST1",
            "type": "string",
            "metadata": {
                "name": "AzS-HOST1"
            }
        },
        "virtualMachineSize": {
            "defaultValue": "Standard_E20s_v3",
            "allowedValues": [
                "Standard_E16s_v3",
                "Standard_E20s_v3",
                "Standard_E32s_v3",
                "Standard_E48s_v3",
                "Standard_E64s_v3",
                "Standard_D32s_v3",
                "Standard_D48s_v3",
                "Standard_D64s_v3"
            ],
            "type": "string",
            "metadata": {
                "name": "Standard_E20s_v3"
            }
        },
        "dataDiskSizeinGB": {
            "type": "int",
            "defaultValue":256,
            "allowedValues": [
                128,
                256,
                512
            ],
            "metadata": {
                "name":256
            }
        },
        "dataDiskCount": {
            "defaultValue": 4,
            "type": "int",
            "metadata": {
                "name": 4
            }
        },
        "virtualNetworkName": {
            "defaultValue": "AzureStack-VNET",
            "type": "string",
            "metadata": {
                "name": "AzureStack-VNET"
            }
        },
        "adminPassword": {
            "type": "securestring"
        },
        "addressPrefix": {
            "defaultValue": "10.0.0.0/24",
            "type": "string",
            "metadata": {
                "name": "10.0.0.0/24"
            }
        },
        "subnetName": {
            "defaultValue": "default",
            "type": "string",
            "metadata": {
                "name": "default"
            }
        },
        "subnetPrefix": {
            "defaultValue": "10.0.0.0/24",
            "type": "string",
            "metadata": {
                "name": "10.0.0.0/24"
            }
        },
        "publicIpAddressType": {
            "defaultValue": "Dynamic",
            "allowedValues": [
                "Dynamic",
                "Static"
            ],
            "type": "string",
            "metadata": {
                "name": "Dynamic"
            }
        },
        "publicDnsName": {
            "type": "string"
        },
        "osDiskVhdUri": {
            "defaultValue": "https://<Azure Blob Storage Prefix>.blob.core.windows.net/<Container Name>/<VHD Name>.vhd",
            "type": "string",
            "metadata": {
                "description": "Uri of the your user image",
                "name": "https://<Azure Blob Storage Prefix>.blob.core.windows.net/<Container Name>/<VHD Name>.vhd"
            }
        },
        "postConfigScriptLocation": { 
            "defaultValue": "https://raw.githubusercontent.com/yagmurs/AzureStack-VM-PoC/master/scripts",
            "type": "string",
            "metadata": {
                "description": "the post config script location",
                "name": "https://raw.githubusercontent.com/yagmurs/AzureStack-VM-PoC/master/scripts"
            }
        },
        "postConfigScriptFilename": { 
            "defaultValue": "post-config.ps1",
            "type": "string",
            "metadata": {
                "description": "the post config script file name",
                "name": "post-config.ps1"
            }
        },
        "autoInstallASDK": {
            "defaultValue": false,
            "allowedValues": [
                false,
                true
            ],
            "type": "bool",
            "metadata": {
                "name": false
            }
        },
        "AzureADTenant": {
            "defaultValue": "<Azure AD Tenant>.onmicrosoft.com",
            "type": "string",
            "metadata": {
                "name": "<Azure AD Tenant>.onmicrosoft.com"
            }
        },
        "AzureADGlobalAdmin": {
            "defaultValue": "Alias@<Azure AD Tenant>.onmicrosoft.com",
            "type": "string",
            "metadata": {
                "name": "Alias@<Azure AD Tenant>.onmicrosoft.com"
            }
        },
        "AzureADGlobalAdminPassword": {
            "type": "securestring",
            "defaultValue": "1234",
            "metadata": {
                "name": "1234"
            }
        },
        "branch": {
            "type": "string",
            "defaultValue": "master",
            "allowedValues": [
                "master",
                "development"
            ],
            "metadata": {
                "name": "master"
            }
        },
        "siteLocation": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "name": "[resourceGroup().location]"
            }
        }
    },
    "variables": {
        "vnetId": "[resourceId(resourceGroup().name,'Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]",
        "subnetRef": "[concat(variables('vnetID'), '/subnets/', parameters('subnetName'))]",
        "fileUri": "[concat(parameters('postConfigScriptLocation'), '/', parameters('postConfigScriptFileName'))]",
        "adminUsername": "__administrator",
        "osDiskSizeinGB": 256,
        "location": "[resourceGroup().location]",
        "networkInterfaceName": "[concat(parameters('virtualMachineName'),'-NIC')]",
        "networkSecurityGroupName": "[concat(parameters('virtualMachineName'),'-NSG')]",
        "publicIpAddressName": "[concat(parameters('virtualMachineName'),'-IP')]",
        "imageName": "asdk_latest",
        "autoInstallASDKparameters": "[if(bool(parameters('autoInstallASDK')), concat(' -AutoInstallASDK ',' -AzureADTenant ', parameters('AzureADTenant'), ' -AzureADGlobalAdmin ', parameters('AzureADGlobalAdmin'), ' -AzureADGlobalAdminPass ', parameters('AzureADGlobalAdminPassword'), ' -LocalAdminPass ', parameters('adminPassword')), '')]"
    },
    "resources": [
        {
            "type": "Microsoft.Compute/images",
            "name": "[variables('imageName')]",
            "apiVersion": "2017-03-30",
            "location": "[variables('location')]",
            "properties": {
                "storageProfile": {
                    "osDisk": {
                        "osType": "Windows",
                        "osState": "Generalized",
                        "blobUri": "[parameters('osDiskVhdUri')]",
                        "storageAccountType": "Premium_LRS"
                    }
                }
            }
        }
    ],
    "outputs": {
        "adminUsername": {
            "type": "string",
            "value": "[concat(parameters('virtualMachineName'),'\\','Administrator')]"
        },
        "IPAddress": {
            "type": "string",
            "value": "[reference(variables('publicIpAddressName')).dnssettings.fqdn]"
        }
    }
}
